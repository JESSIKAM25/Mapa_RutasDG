<!DOCTYPE html>
<html>
<head><meta charset="utf-8"><title>Rutas Conductor</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style> body, html{margin:0;height:100%}#map{height:100%}</style>
</head>
<body><div id="map"></div>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
  const sheetURL = 'https://opensheet.vercel.app/1AMJ_afjdWv_B38czZE-cvAklNuDpboY959VYIHQPj-s/Hoja1';
  const map = L.map('map').setView([-0.22985,-78.52495],12);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:18, attribution:'&copy; OpenStreetMap contributors'}).addTo(map);

  fetch(sheetURL).then(r=>r.json()).then(data=>{
    const porConductor = {};
    data.forEach(fila=>{
      const [lat,long]=fila['coordenadas geo'].split(',').map(v=>parseFloat(v.trim()));
      const t = fila.transportista;
      const h = new Date(fila['fecha&horaGPS']);
      if(isNaN(lat)||isNaN(long))return;
      porConductor[t] = porConductor[t]||[];
      porConductor[t].push({lat,long,h,fila});
    });
    Object.entries(porConductor).forEach(([t,pts],i)=>{
      pts.sort((a,b)=>a.h - b.h);
      const coords = pts.map(p=>[p.lat,p.long]);
      L.polyline(coords,{color:['#ff0000','#0000ff','#00aa00'][i%3],weight:4}).addTo(map)
        .bindPopup(`Ruta de ${t}`);
      pts.forEach(p=>{
        L.marker([p.lat,p.long]).addTo(map)
          .bindPopup(`<b>${t}</b><br>${p.h.toLocaleString()}<br>${p.fila['direccion coordenadas']||''}`);
      });
    });
  }).catch(err=>console.error(err));
</script>
</body></html>